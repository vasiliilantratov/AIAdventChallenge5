# FAQ: Семантический поиск и RAG в системе Соната-2041

## Вопрос: Как работает семантический поиск?

**Ответ:**
Семантический поиск в Соната-2041 использует векторные эмбеддинги для нахождения документов по смыслу, а не по точному совпадению слов:

1. **Запрос преобразуется в вектор** с помощью модели `nomic-embed-text`
2. **Вычисляется косинусное сходство** между вектором запроса и векторами всех чанков
3. **Возвращаются наиболее похожие** результаты

Это позволяет находить документы даже если они используют синонимы или другие формулировки.

## Вопрос: Как использовать поиск?

**Ответ:**
Используйте команду `search`:

```bash
./gradlew run --args="search \"ваш запрос\" --top-k 10"
```

Параметры:
- `--top-k` - количество результатов (по умолчанию: 10)
- `--ollama-url` - URL сервера Ollama
- `--db-path` - путь к базе данных

## Вопрос: Что такое RAG?

**Ответ:**
RAG (Retrieval-Augmented Generation) - это подход, при котором LLM (большая языковая модель) генерирует ответ на основе найденных в базе знаний документов:

1. **Retrieval (поиск)**: Система находит релевантные фрагменты документов
2. **Augmentation (дополнение)**: Найденные фрагменты добавляются в контекст
3. **Generation (генерация)**: LLM генерирует ответ на основе контекста

Это позволяет получать точные ответы, основанные на ваших документах.

## Вопрос: Как задать вопрос с RAG?

**Ответ:**
Используйте команду `qa` в режиме `rag`:

```bash
# Базовый RAG
./gradlew run --args='qa --mode rag Что такое проект Соната-2041?'

# С настройкой количества чанков
./gradlew run --args='qa --mode rag --top-k 5 Что такое проект Соната-2041?'
```

После ответа система автоматически покажет источники данных, использованные для формирования ответа.

## Вопрос: Что такое реранкинг и зачем он нужен?

**Ответ:**
Реранкинг - это дополнительный этап обработки результатов поиска, который повышает точность:

**Без реранкинга:**
1. Семантический поиск находит топ-K результатов по косинусному сходству

**С реранкингом:**
1. Семантический поиск находит больше результатов (rerank-top-k)
2. LLM оценивает релевантность каждого результата к запросу (0.0-1.0)
3. Результаты сортируются по оценке релевантности
4. Возвращаются топ-K лучших результатов

**Преимущества реранкинга:**
- Более точная оценка релевантности
- Учет контекста запроса
- Лучшее качество ответов

**Недостатки:**
- Медленнее (требуются дополнительные запросы к LLM)
- Больше нагрузка на сервер

## Вопрос: Как использовать реранкинг?

**Ответ:**
Добавьте флаг `--enable-reranking`:

```bash
./gradlew run --args='qa --mode rag --enable-reranking Что такое проект Соната-2041?'
```

Дополнительные параметры:
- `--rerank-top-k` - сколько результатов получить для реранкинга (по умолчанию: top-k * 2)
- `--relevance-threshold` - порог релевантности для фильтрации (0.0-1.0)

## Вопрос: Что такое relevance-threshold?

**Ответ:**
Relevance threshold (порог релевантности) - это минимальная оценка релевантности для включения результата в ответ.

**Как работает:**
1. После реранкинга каждый результат имеет оценку от 0.0 до 1.0
2. Результаты с оценкой ниже порога исключаются
3. Только результаты выше порога используются для генерации ответа

**Рекомендуемые значения:**
- `0.3` - мягкая фильтрация (включает больше результатов)
- `0.5` - средняя фильтрация (баланс)
- `0.7` - строгая фильтрация (только самые релевантные)

**Пример:**
```bash
./gradlew run --args='qa --mode rag --enable-reranking --relevance-threshold 0.4 Что такое проект Соната-2041?'
```

## Вопрос: Поиск возвращает нерелевантные результаты

**Ответ:**
Если поиск возвращает нерелевантные результаты:

1. **Используйте реранкинг**: Добавьте `--enable-reranking` для более точной оценки
2. **Настройте порог релевантности**: Используйте `--relevance-threshold` для фильтрации
3. **Уменьшите top-k**: Меньше результатов = выше качество
4. **Уточните запрос**: Более конкретный запрос дает лучшие результаты
5. **Проверьте индекс**: Убедитесь, что в индексе есть релевантные документы

## Вопрос: Что такое "кварцевый шёпот" (КШ)?

**Ответ:**
"Кварцевый шёпот" - это термин, введенный в проекте Соната-2041 для обозначения "мягких совпадений" в семантическом поиске.

**Определение:** Ответ не цитирует точную фразу из документа, но сохраняет смысл и контекст.

**Примеры:**
- Запрос: "Когда начался проект?"
- Документ: "Официальный старт: 3 марта 2041 года"
- Ответ (КШ): "Проект стартовал в марте 2041 года"

Система использует семантические эмбеддинги и LLM для создания таких "мягких" ответов, которые передают смысл без точного цитирования.

## Вопрос: Как просмотреть историю диалогов?

**Ответ:**
Все вопросы и ответы автоматически сохраняются в истории. Используйте команду `history`:

```bash
# Список последних бесед
./gradlew run --args="history"

# Просмотр конкретной беседы
./gradlew run --args="history --conversation-id 1"

# Полный формат с источниками
./gradlew run --args="history --conversation-id 1 --format full"
```

Параметры:
- `--conversation-id` - ID беседы для просмотра
- `--limit` - количество бесед/сообщений (по умолчанию: 10)
- `--format` - формат вывода: `short` (краткий) или `full` (полный)

## Вопрос: Чем отличается режим plain от rag?

**Ответ:**

**Режим plain (без RAG):**
- LLM отвечает без учета индексированных документов
- Использует только встроенные знания модели
- Быстрее, но может не знать специфичной информации
- Не показывает источники

```bash
./gradlew run --args='qa --mode plain Что такое Kotlin?'
```

**Режим rag (с RAG):**
- LLM отвечает на основе найденных в индексе документов
- Использует контекст из ваших документов
- Медленнее, но более точный для специфичных вопросов
- Показывает источники данных

```bash
./gradlew run --args='qa --mode rag Что такое проект Соната-2041?'
```

**Когда использовать какой режим:**
- Plain: общие вопросы, не связанные с вашими документами
- RAG: вопросы о содержимом ваших документов
