# ะกะฒะพะดะบะฐ ัะตะฐะปะธะทะฐัะธะธ: MCP Weather Server Integration

## ะงัะพ ะฑัะปะพ ัะดะตะปะฐะฝะพ

### 1. ะกะพะทะดะฐะฝ ะฝะพะฒัะน Gradle ะผะพะดัะปั `weather-server`

**ะกัััะบัััะฐ ะผะพะดัะปั:**
```
weather-server/
โโโ build.gradle.kts
โโโ src/main/kotlin/org/example/weather/
    โโโ WeatherApiModels.kt    - ะะพะดะตะปะธ ะดะฐะฝะฝัั ะดะปั WeatherAPI
    โโโ WeatherApiClient.kt    - HTTP-ะบะปะธะตะฝั ะดะปั ะฟะพะปััะตะฝะธั ะฟะพะณะพะดั
    โโโ WeatherServer.kt       - MCP ัะตัะฒะตั (JSON-RPC over stdio)
```

**ะะตะฐะปะธะทะพะฒะฐะฝะฝะฐั ััะฝะบัะธะพะฝะฐะปัะฝะพััั:**
- HTTP-ะบะปะธะตะฝั ะดะปั WeatherAPI (https://www.weatherapi.com/)
- API ะบะปัั: `723a066898ce45aa97c180652251612`
- MCP ัะตัะฒะตั, ัะตะฐะปะธะทัััะธะน JSON-RPC 2.0 ะฟัะพัะพะบะพะป ัะตัะตะท stdin/stdout
- ะะฝััััะผะตะฝั `get_current_weather` ะดะปั ะฟะพะปััะตะฝะธั ัะตะบััะตะน ะฟะพะณะพะดั ะฟะพ ะฝะฐะทะฒะฐะฝะธั ะณะพัะพะดะฐ

**ะขะตัะฝะธัะตัะบะธะต ะดะตัะฐะปะธ:**
- ะัะพัะพะบะพะป: JSON-RPC 2.0 over stdio (ะฑะตะท ะธัะฟะพะปัะทะพะฒะฐะฝะธั SDK)
- ะะพะดะดะตัะถะธะฒะฐะตะผัะต ะผะตัะพะดั:
  - `initialize` - ะธะฝะธัะธะฐะปะธะทะฐัะธั ัะพะตะดะธะฝะตะฝะธั
  - `tools/list` - ะฟะพะปััะตะฝะธะต ัะฟะธัะบะฐ ะดะพัััะฟะฝัั ะธะฝััััะผะตะฝัะพะฒ
  - `tools/call` - ะฒัะทะพะฒ ะธะฝััััะผะตะฝัะฐ
- ะะพะทะฒัะฐัะฐะตะผัะต ะดะฐะฝะฝัะต: ัะตะผะฟะตัะฐัััะฐ, ะฒะปะฐะถะฝะพััั, ะฒะตัะตั, ะพัะฐะดะบะธ, ะดะฐะฒะปะตะฝะธะต, ะฒะธะดะธะผะพััั, ะฃะค-ะธะฝะดะตะบั

### 2. ะะฝัะตะณัะธัะพะฒะฐะฝ MCP ะบะปะธะตะฝั ะฒ ะณะปะฐะฒะฝะพะต ะฟัะธะปะพะถะตะฝะธะต

**ะะพะฒัะน ัะฐะนะป: `McpClientManager.kt`**
- ะฃะฟัะฐะฒะปัะตั ะถะธะทะฝะตะฝะฝัะผ ัะธะบะปะพะผ MCP weather server
- ะะฐะฟััะบะฐะตั ัะตัะฒะตั ะบะฐะบ subprocess ัะตัะตะท Gradle
- ะะพะดะบะปััะฐะตััั ัะตัะตะท stdin/stdout (StdioTransport)
- ะัะฟัะฐะฒะปัะตั JSON-RPC ะทะฐะฟัะพัั ะธ ะฟะพะปััะฐะตั ะพัะฒะตัั
- ะะพะฝะฒะตััะธััะตั MCP ะธะฝััััะผะตะฝัั ะฒ ัะพัะผะฐั Ollama tools

**ะะปััะตะฒัะต ะผะตัะพะดั:**
- `startWeatherServer()` - ะทะฐะฟััะบ ะธ ะธะฝะธัะธะฐะปะธะทะฐัะธั ัะตัะฒะตัะฐ
- `callTool(name, arguments)` - ะฒัะทะพะฒ ะธะฝััััะผะตะฝัะฐ MCP ัะตัะฒะตัะฐ
- `convertToolsForOllama()` - ะบะพะฝะฒะตััะฐัะธั tool definitions ะดะปั Ollama
- `close()` - ะบะพััะตะบัะฝะพะต ะทะฐะฒะตััะตะฝะธะต ัะตัะฒะตัะฐ

### 3. ะะฐััะธัะตะฝะฐ ะฟะพะดะดะตัะถะบะฐ Tool Calling ะฒ ัะฐั-ะฟัะธะปะพะถะตะฝะธะธ

**ะะทะผะตะฝะตะฝะธั ะฒ `DomainModels.kt`:**
- ะะพะฑะฐะฒะปะตะฝั `ToolCall` ะธ `ToolFunction` ะดะปั ะฟัะตะดััะฐะฒะปะตะฝะธั ะฒัะทะพะฒะพะฒ ะธะฝััััะผะตะฝัะพะฒ
- ะะฐััะธัะตะฝ `ChatMessage` ะธ `OllamaMessage` ะดะปั ะฟะพะดะดะตัะถะบะธ `toolCalls`
- ะะฐััะธัะตะฝ `OllamaChatRequest` ะดะปั ะพัะฟัะฐะฒะบะธ ัะฟะธัะบะฐ ะธะฝััััะผะตะฝัะพะฒ
- ะะพะฑะฐะฒะปะตะฝ `AnySerializer` ะดะปั ัะตัะธะฐะปะธะทะฐัะธะธ ะดะธะฝะฐะผะธัะตัะบะธั ะฟะฐัะฐะผะตััะพะฒ ะธะฝััััะผะตะฝัะพะฒ

**ะะทะผะตะฝะตะฝะธั ะฒ `OllamaChatClient.kt`:**
- ะะพะฑะฐะฒะปะตะฝ ะฟะฐัะฐะผะตัั `tools` ะฒ ะผะตัะพะด `sendChatRequest()`
- ะะฝััััะผะตะฝัั ะพัะฟัะฐะฒะปััััั ะฒ ะบะฐะถะดะพะผ ะทะฐะฟัะพัะต ะบ Ollama

**ะะทะผะตะฝะตะฝะธั ะฒ `AiDialogService.kt` (ChatSession):**
- ะะพะฑะฐะฒะปะตะฝ ะฟะฐัะฐะผะตัั `mcpClientManager` ะฒ ะบะพะฝััััะบัะพั
- ะะตะฐะปะธะทะพะฒะฐะฝ ัะธะบะป ะพะฑัะฐะฑะพัะบะธ tool calls:
  1. ะัะฟัะฐะฒะบะฐ ะทะฐะฟัะพัะฐ ั ะดะพัััะฟะฝัะผะธ ะธะฝััััะผะตะฝัะฐะผะธ
  2. ะัะพะฒะตัะบะฐ ะพัะฒะตัะฐ ะฝะฐ ะฝะฐะปะธัะธะต tool calls
  3. ะัะฟะพะปะฝะตะฝะธะต tool calls ัะตัะตะท MCP
  4. ะัะฟัะฐะฒะบะฐ ัะตะทัะปััะฐัะพะฒ ะพะฑัะฐัะฝะพ ะฒ Ollama
  5. ะะพะปััะตะฝะธะต ัะธะฝะฐะปัะฝะพะณะพ ะพัะฒะตัะฐ ะพั AI
- ะะพะฑะฐะฒะปะตะฝ ะผะตัะพะด `handleToolCalls()` ะดะปั ะพะฑัะฐะฑะพัะบะธ ะฒัะทะพะฒะพะฒ ะธะฝััััะผะตะฝัะพะฒ
- ะะฐะบัะธะผัะผ 5 ะธัะตัะฐัะธะน ะดะปั ะฟัะตะดะพัะฒัะฐัะตะฝะธั ะฑะตัะบะพะฝะตัะฝัั ัะธะบะปะพะฒ

**ะะทะผะตะฝะตะฝะธั ะฒ `Main.kt`:**
- ะะฝะธัะธะฐะปะธะทะฐัะธั `McpClientManager` ะฟัะธ ััะฐััะต
- ะะฐะฟััะบ MCP weather server
- ะะตัะตะดะฐัะฐ ะบะปะธะตะฝัะฐ ะฒ `ChatSession`
- ะะพััะตะบัะฝะพะต ะทะฐะบัััะธะต ัะตัะฒะตัะฐ ะฟัะธ ะฒััะพะดะต

### 4. ะะฑะฝะพะฒะปะตะฝะฐ ะดะพะบัะผะตะฝัะฐัะธั

**ะกะพะทะดะฐะฝะฝัะต ัะฐะนะปั:**
- `WEATHER_MCP_README.md` - ะฟะพะดัะพะฑะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั ะฟะพ MCP ะธะฝัะตะณัะฐัะธะธ
- `IMPLEMENTATION_SUMMARY.md` - ััะพั ัะฐะนะป ั ะพะฟะธัะฐะฝะธะตะผ ัะตะฐะปะธะทะฐัะธะธ

**ะะฑะฝะพะฒะปะตะฝะฝัะต ัะฐะนะปั:**
- `README.md` - ะดะพะฑะฐะฒะปะตะฝะฐ ะธะฝัะพัะผะฐัะธั ะพ MCP ะธ ะฟัะธะผะตัั ะธัะฟะพะปัะทะพะฒะฐะฝะธั

## ะััะธัะตะบัััะฐ ัะตัะตะฝะธั

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         Main Application                โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ         Main.kt                   โ  โ
โ  โ  - ะะฝะธัะธะฐะปะธะทะฐัะธั ะบะพะผะฟะพะฝะตะฝัะพะฒ      โ  โ
โ  โ  - ะฃะฟัะฐะฒะปะตะฝะธะต ะถะธะทะฝะตะฝะฝัะผ ัะธะบะปะพะผ    โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                  โ                       โ
โ     โโโโโโโโโโโโโโดโโโโโโโโโโโโโ         โ
โ     โผ                         โผ          โ
โ  โโโโโโโโโโโโโโโ       โโโโโโโโโโโโโโโโ โ
โ  โ ChatSession โ       โ McpClient    โ โ
โ  โ             โโโโโโโโโค Manager      โ โ
โ  โ - Tool call โ       โ              โ โ
โ  โ   loop      โ       โ - Subprocess โ โ
โ  โ - History   โ       โ   management โ โ
โ  โโโโโโโโฌโโโโโโโ       โ - JSON-RPC   โ โ
โ         โ              โโโโโโโโฌโโโโโโโโ โ
โ         โ                     โ          โ
โ         โผ                     โ          โ
โ  โโโโโโโโโโโโโโโโ             โ         โ
โ  โ OllamaChat   โ             โ         โ
โ  โ Client       โ             โ         โ
โ  โ              โ             โ         โ
โ  โ + tools      โ             โ         โ
โ  โโโโโโโโโโโโโโโโ             โ         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโ
                                 โ
                          stdin/stdout
                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโ
โ         Weather Server         โ         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโ  โ
โ  โ    WeatherServer.kt               โ  โ
โ  โ    - JSON-RPC handler             โ  โ
โ  โ    - Tool: get_current_weather    โ  โ
โ  โโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโ  โ
โ                  โ                       โ
โ                  โผ                       โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ    WeatherApiClient.kt            โ โ
โ  โ    - HTTP requests to WeatherAPI  โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ะขะตัะฝะธัะตัะบะธะต ัะตัะตะฝะธั

### ะะพัะตะผั ะฝะต ะธัะฟะพะปัะทะพะฒะฐะปะธ MCP Kotlin SDK ะฝะฐะฟััะผัั?
- SDK version 0.8.0 ะธะผะตะป ะฟัะพะฑะปะตะผั ั ัะฐะทัะตัะตะฝะธะตะผ ะบะปะฐััะพะฒ
- ะะตัะตะฝะธะต: ะะตะฐะปะธะทะพะฒะฐะปะธ JSON-RPC ะฟัะพัะพะบะพะป ะฝะฐะฟััะผัั
- ะัะตะธะผััะตััะฒะฐ:
  - ะะพะปะฝัะน ะบะพะฝััะพะปั ะฝะฐะด ะฟัะพัะพะบะพะปะพะผ
  - ะะตั ะทะฐะฒะธัะธะผะพััะตะน ะพั ะฝะตััะฐะฑะธะปัะฝะพะณะพ SDK
  - ะัะพัะต ะพัะปะฐะดะบะฐ ะธ ะฟะพะฝะธะผะฐะฝะธะต ัะฐะฑะพัั

### ะะฐะฟััะบ ัะตัะตะท installDist ะฒะผะตััะพ gradle run
**ะัะพะฑะปะตะผะฐ:** ะัะธ ะทะฐะฟััะบะต ัะตัะตะท `gradlew :weather-server:run` Gradle ัะฟัะฐะฒะปัะตั ะฟะพัะพะบะฐะผะธ ะฒะฒะพะดะฐ/ะฒัะฒะพะดะฐ, ััะพ ะฝะต ะฟะพะทะฒะพะปัะตั ะฝะฐะฟััะผัั ะฟะธัะฐัั ะฒ stdin ะฟัะพัะตััะฐ.

**ะะตัะตะฝะธะต:** 
1. ะัะฟะพะปัะทัะตะผ `installDist` task ะดะปั ัะพะทะดะฐะฝะธั standalone distribution
2. ะะฐะฟััะบะฐะตะผ weather server ะบะฐะบ ะพัะดะตะปัะฝัะน ะฟัะพัะตัั ัะตัะตะท ัะบัะธะฟั
3. ะะพะปััะฐะตะผ ะฟััะผะพะน ะดะพัััะฟ ะบ stdin/stdout ะฟัะพัะตััะฐ

**ะัะตะธะผััะตััะฒะฐ:**
- ะะพะปะฝัะน ะบะพะฝััะพะปั ะฝะฐะด ะฟะพัะพะบะฐะผะธ ะฒะฒะพะดะฐ/ะฒัะฒะพะดะฐ
- ะัััััะน ะทะฐะฟััะบ (ะฝะต ะฝัะถะฝะพ ะบะฐะถะดัะน ัะฐะท ะทะฐะฟััะบะฐัั Gradle)
- ะะพะทะผะพะถะฝะพััั ัะธัะฐัั stderr ะดะปั ะปะพะณะธัะพะฒะฐะฝะธั
- ะกัะฐะฑะธะปัะฝะฐั ะบะพะผะผัะฝะธะบะฐัะธั ัะตัะตะท JSON-RPC

### ะัะฑะพั stdio transport
- ะกัะฐะฝะดะฐััะฝัะน ัะฟะพัะพะฑ ะบะพะผะผัะฝะธะบะฐัะธะธ ะดะปั MCP ัะตัะฒะตัะพะฒ
- ะัะพััะฐั ะธะฝัะตะณัะฐัะธั ัะตัะตะท subprocess
- ะะต ััะตะฑัะตั ัะตัะตะฒัั ะฝะฐัััะพะตะบ

### Tool calling flow
```
User โ Ollama (with tools) โ Tool Call โ MCP Server โ Weather API
                                   โ
User โ Ollama (final answer) โ Tool Result โ JSON Response
```

## ะัะฟะพะปัะทะพะฒะฐะฝะธะต

### ะัะพััะพะน ะทะฐะฟััะบ
```bash
./gradlew run
```

### ะัะธะผะตั ะดะธะฐะปะพะณะฐ
```
ะะพะปัะทะพะฒะฐัะตะปั: ะะฐะบะฐั ัะตะนัะฐั ะฟะพะณะพะดะฐ ะฒ ะะพัะบะฒะต?
/end

๐ง ะะ ะฒัะทัะฒะฐะตั ะธะฝััััะผะตะฝัั:
  - get_current_weather ั ะฐัะณัะผะตะฝัะฐะผะธ: {"city":"Moscow"}
  โ ะะตะทัะปััะฐั: {"location":{"name":"Moscow",...}, "current":{...}}

ะะ: ะกะตะนัะฐั ะฒ ะะพัะบะฒะต ัะตะผะฟะตัะฐัััะฐ -5ยฐC, ะพัััะฐะตััั ะบะฐะบ -8ยฐC. 
ะะฑะปะฐัะฝะพ, ะฒะปะฐะถะฝะพััั 80%, ะฒะตัะตั ะทะฐะฟะฐะดะฝัะน 15 ะบะผ/ั. 
ะะฐะฒะปะตะฝะธะต 1015 ะผะฑะฐั, ะฒะธะดะธะผะพััั 10 ะบะผ.
```

## ะขะตััะธัะพะฒะฐะฝะธะต

### ะัะพะฒะตัะบะฐ ัะฑะพัะบะธ
```bash
./gradlew build
```

### ะกะฑะพัะบะฐ ัะพะปัะบะพ weather-server
```bash
./gradlew :weather-server:build
```

### ะะฐะฟััะบ weather-server ะพัะดะตะปัะฝะพ (ะดะปั ะพัะปะฐะดะบะธ)
```bash
./gradlew :weather-server:run
```
ะะฐัะตะผ ะผะพะถะฝะพ ะพัะฟัะฐะฒะปััั JSON-RPC ะทะฐะฟัะพัั ะฒ stdin.

## ะะฐััะธััะตะผะพััั

### ะะพะฑะฐะฒะปะตะฝะธะต ะฝะพะฒัั ะธะฝััััะผะตะฝัะพะฒ
1. ะะพะฑะฐะฒััะต ะพะฟะธัะฐะฝะธะต ะฒ `tools/list` handler
2. ะะพะฑะฐะฒััะต ะพะฑัะฐะฑะพัะบั ะฒ `tools/call` handler
3. ะะตะฐะปะธะทัะนัะต ะปะพะณะธะบั ะธะฝััััะผะตะฝัะฐ

### ะะฝัะตะณัะฐัะธั ะดััะณะธั API
1. ะะฐะผะตะฝะธัะต `WeatherApiClient` ะฝะฐ ะฝัะถะฝัะน ะบะปะธะตะฝั
2. ะะฑะฝะพะฒะธัะต ะผะพะดะตะปะธ ะดะฐะฝะฝัั
3. ะะฑะฝะพะฒะธัะต ะพะฟะธัะฐะฝะธั ะธะฝััััะผะตะฝัะพะฒ

### ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะดััะณะธั ะผะพะดะตะปะตะน
- ะฃะฑะตะดะธัะตัั, ััะพ ะผะพะดะตะปั ะฟะพะดะดะตัะถะธะฒะฐะตั function/tool calling
- ะะทะผะตะฝะธัะต `SUPPORTED_MODELS` ะฒ `DomainModels.kt`

## ะะทะฒะตััะฝัะต ะพะณัะฐะฝะธัะตะฝะธั

1. **ะัะตะผั ะทะฐะฟััะบะฐ:** Weather server ััะตะฑัะตั ~2-3 ัะตะบัะฝะดั ะดะปั ะทะฐะฟััะบะฐ
2. **ะฏะทัะบ:** ะะฐะทะฒะฐะฝะธั ะณะพัะพะดะพะฒ ะดะพะปะถะฝั ะฑััั ะฝะฐ ะฐะฝะณะปะธะนัะบะพะผ
3. **API ะปะธะผะธัั:** WeatherAPI ะธะผะตะตั ะพะณัะฐะฝะธัะตะฝะธั ะฝะฐ ะบะพะปะธัะตััะฒะพ ะทะฐะฟัะพัะพะฒ
4. **ะะพะดะตะปะธ:** ะขัะตะฑัะตััั ะผะพะดะตะปั ั ะฟะพะดะดะตัะถะบะพะน tool calling

## ะะฐะฒะธัะธะผะพััะธ

### Main application
- `kotlinx-serialization-json:1.6.2` - ัะตัะธะฐะปะธะทะฐัะธั JSON
- `ktoken:0.4.0` - ะฟะพะดััะตั ัะพะบะตะฝะพะฒ
- `sqlite-jdbc:3.44.1.0` - SQLite ะฑะฐะทะฐ ะดะฐะฝะฝัั
- `kotlin-sdk:0.8.0` - ะทะฐะฒะธัะธะผะพััั ะฟัะธัััััะฒัะตั, ะฝะพ ะฝะต ะธัะฟะพะปัะทัะตััั

### Weather server
- `kotlinx-serialization-json:1.6.2` - ัะตัะธะฐะปะธะทะฐัะธั JSON
- `kotlinx-coroutines-core:1.7.3` - ะบะพัััะธะฝั

## ะัะฒะพะดั

ะะตะฐะปะธะทะพะฒะฐะฝะฐ ะฟะพะปะฝะฐั ะธะฝัะตะณัะฐัะธั MCP weather server ะฒ Ollama ัะฐั-ะฟัะธะปะพะถะตะฝะธะต:
- โ ะกะพะทะดะฐะฝ ะพัะดะตะปัะฝัะน Gradle ะผะพะดัะปั ะดะปั weather server
- โ ะะตะฐะปะธะทะพะฒะฐะฝ MCP ะฟัะพัะพะบะพะป ัะตัะตะท JSON-RPC over stdio
- โ ะะฝัะตะณัะธัะพะฒะฐะฝ MCP ะบะปะธะตะฝั ะฒ ะณะปะฐะฒะฝะพะต ะฟัะธะปะพะถะตะฝะธะต
- โ ะะพะฑะฐะฒะปะตะฝะฐ ะฟะพะดะดะตัะถะบะฐ tool calling ะฒ ะดะธะฐะปะพะณะต
- โ AI ะผะพะถะตั ัะฐะผะพััะพััะตะปัะฝะพ ะฟะพะปััะฐัั ะดะฐะฝะฝัะต ะพ ะฟะพะณะพะดะต
- โ ะะพะปะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั ะธ ะฟัะธะผะตัั ะธัะฟะพะปัะทะพะฒะฐะฝะธั

ะัะธะปะพะถะตะฝะธะต ะณะพัะพะฒะพ ะบ ะธัะฟะพะปัะทะพะฒะฐะฝะธั ะธ ะผะพะถะตั ะฑััั ะปะตะณะบะพ ัะฐััะธัะตะฝะพ ะฝะพะฒัะผะธ ะธะฝััััะผะตะฝัะฐะผะธ.

