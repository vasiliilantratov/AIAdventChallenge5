# Semantic Search Application

Консольное приложение на Kotlin для семантического поиска по локальным документам с использованием Ollama и SQLite.

## Требования

- Java 21+
- Gradle
- Ollama с установленной моделью `nomic-embed-text:latest`

### Установка Ollama модели

```bash
ollama pull nomic-embed-text:latest
```

## Сборка

```bash
./gradlew build
```

## Использование

### Индексация директории

```bash
./gradlew run --args="index /path/to/documents --chunk-size 512 --overlap 50"
```

Параметры:
- `--chunk-size`: Размер чанка в символах (по умолчанию: 512)
- `--overlap`: Размер overlap между чанками (по умолчанию: 50)
- `--ollama-url`: URL Ollama сервера (по умолчанию: http://localhost:11434)
- `--db-path`: Путь к файлу SQLite (по умолчанию: ./index.db)

### Поиск

```bash
./gradlew run --args="search \"ваш запрос\" --top-k 10"
```

Параметры:
- `--top-k`: Количество результатов (по умолчанию: 10)
- `--ollama-url`: URL Ollama сервера
- `--db-path`: Путь к файлу SQLite

### Статистика индекса

```bash
./gradlew run --args="stats"
```

### Очистка индекса

```bash
./gradlew run --args="clear"
```

### Удаление документа из индекса

```bash
./gradlew run --args="remove /path/to/file.md"
```

### Вопрос к LLM (режимы с RAG / без RAG)

Команда `qa` отправляет вопрос в LLM в одном из двух режимов:

```bash
# Без RAG (модель отвечает без учёта индекса)
./gradlew run --args='qa --mode plain Что такое проект Соната-2041?'

# С RAG (поиск релевантных чанков + ответ по контексту)
./gradlew run --args='qa --mode rag --top-k 5 Что такое проект Соната-2041?'

# С RAG и реранкингом (более точная оценка релевантности через LLM)
./gradlew run --args='qa --mode rag --enable-reranking Что такое проект Соната-2041?'

# С RAG, реранкингом и фильтрацией по порогу релевантности

```

**Примечание:** При использовании `./gradlew run --args` слова вопроса передаются как отдельные аргументы, поэтому кавычки не нужны. Если вопрос содержит специальные символы, используйте одинарные кавычки снаружи: `./gradlew run --args='qa --mode rag Ваш вопрос здесь'`

Параметры:
- `--mode`: `plain` (без RAG, по умолчанию) или `rag` (с поиском по индексированным документам)
- `--top-k`: количество чанков для режима `rag` (по умолчанию: 5)
- `--enable-reranking`: включить реранкинг результатов через LLM для более точной оценки релевантности (медленнее, но точнее)
- `--relevance-threshold`: порог релевантности для фильтрации результатов (0.0-1.0). Результаты с оценкой ниже порога будут исключены
- `--rerank-top-k`: количество результатов для реранкинга (по умолчанию: `top-k * 2`). Используется только при включенном реранкинге
- `--ollama-url`: URL Ollama сервера (по умолчанию: http://localhost:11434)
- `--db-path`: путь к файлу SQLite (по умолчанию: ./index.db)

#### Реранкинг и фильтрация

При включенном реранкинге (`--enable-reranking`) система выполняет двухэтапную обработку результатов:

1. **Семантический поиск**: Получает больше результатов (по умолчанию `top-k * 2`, настраивается через `--rerank-top-k`)
2. **Предварительная фильтрация**: Отфильтровывает заведомо нерелевантные результаты перед реранкингом
3. **Реранкинг**: LLM переоценивает релевантность каждого чанка к запросу (оценка 0.0-1.0)
4. **Фильтрация по порогу**: Если задан `--relevance-threshold`, результаты с оценкой ниже порога исключаются
5. **Выбор топ-K**: Берется указанное количество лучших результатов (`--top-k`)

Статистика обработки выводится в консоль, показывая количество результатов на каждом этапе.

## Примеры

```bash
# Индексация текущей директории
./gradlew run --args="index . --chunk-size 512 --overlap 50"

# Поиск
./gradlew run --args="search \"как работает корутины\" --top-k 5"

# Статистика
./gradlew run --args="stats"

# Вопрос с RAG без реранкинга
./gradlew run --args='qa --mode rag Что такое проект Соната-2041?'

# Вопрос с RAG и реранкингом
./gradlew run --args='qa --mode rag --enable-reranking Что такое проект Соната-2041?'

# Вопрос с RAG, реранкингом и фильтрацией
./gradlew run --args='qa --mode rag --enable-reranking --relevance-threshold 0.4 --top-k 3 Что такое проект Соната-2041?'
```

## Поддерживаемые форматы файлов

- Markdown: `.md`
- Текст: `.txt`
- Код: `.kt`, `.java`, `.js`, `.ts`, `.jsx`, `.tsx`, `.py`, `.rs`, `.go`, `.cpp`, `.c`, `.h`, `.hpp`, `.cs`, `.rb`, `.php`, `.swift`, `.scala`, `.clj`
- Конфигурация: `.yaml`, `.yml`, `.json`, `.xml`, `.html`, `.css`, `.sh`

Максимальный размер файла: 10MB

## Архитектура

- **Инкрементальная индексация**: Файлы переиндексируются только при изменении (проверка по хешу SHA-256)
- **Чанкинг с overlap**: Текст разбивается на чанки с перекрытием для сохранения контекста
- **Семантический поиск**: Использует косинусное сходство векторов эмбеддингов
- **Реранкинг**: Опциональная переоценка релевантности результатов через LLM для повышения точности
- **Фильтрация по порогу**: Исключение нерелевантных результатов на основе оценки релевантности
- **SQLite**: Локальное хранение индекса с поддержкой каскадного удаления

## Структура базы данных

- `documents`: Метаданные файлов
- `chunks`: Текстовые чанки с позициями
- `embeddings`: Векторы эмбеддингов

